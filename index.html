<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>送迎所要時間計算プログラム</title>
  <!-- Google Maps API の読み込み（YOUR_API_KEY はご自身のAPIキーに変更） -->
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h1, h2 { text-align: center; }
    label { display: block; margin: 10px 0; }
    select, input { width: 300px; padding: 5px; }
    #output { margin-top: 20px; border: 1px solid #ccc; padding: 10px; }
  </style>
</head>
<body>
  <h1>送迎所要時間計算プログラム</h1>
  <form id="calcForm">
    <label>
      スタッフ名:
      <input type="text" id="staffName" placeholder="例: K先生">
    </label>
    <label>
      出発地:
      <select id="originSelect"></select>
    </label>
    <label>
      経由地（任意）:
      <select id="waypointSelect">
        <option value="">（なし）</option>
      </select>
    </label>
    <label>
      到着地:
      <select id="destinationSelect"></select>
    </label>
    <label>
      出発時刻:
      <input type="time" id="departureTime" value="13:00">
    </label>
    <button type="button" id="calcButton">所要時間を計算する</button>
  </form>
  
  <div id="output"></div>
  
  <script>
    // ① スプレッドシートのデータを模擬（本来は外部から取得することも可能）
    // ここでは「場所の名前 - 住所」のリストとして定義
    const places = {
      "池田": "東京都文京区池田町1-1-1",
      "清家": "東京都文京区清家町2-2-2",
      "藤井": "東京都文京区藤井町3-3-3",
      "デイサービス": "東京都文京区デイサービス町4-4-4"
    };

    // ② 各 select 要素に場所リストをセット
    function populateSelect(selectElement) {
      for (const [name, address] of Object.entries(places)) {
        const option = document.createElement("option");
        option.value = address;
        option.textContent = name;
        selectElement.appendChild(option);
      }
    }
    window.addEventListener("load", () => {
      populateSelect(document.getElementById("originSelect"));
      populateSelect(document.getElementById("destinationSelect"));
      populateSelect(document.getElementById("waypointSelect"));
    });

    // ③ ルート検索と所要時間計算
    document.getElementById("calcButton").addEventListener("click", () => {
      const staffName = document.getElementById("staffName").value.trim();
      const origin = document.getElementById("originSelect").value;
      const destination = document.getElementById("destinationSelect").value;
      const waypointAddress = document.getElementById("waypointSelect").value;
      const departureTimeStr = document.getElementById("departureTime").value;

      if (!staffName || !origin || !destination) {
        alert("スタッフ名、出発地、到着地は必須です。");
        return;
      }

      // 出発時刻を Date オブジェクトに変換 (本日の出発時刻として)
      const now = new Date();
      const [hours, minutes] = departureTimeStr.split(":").map(Number);
      const departureTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);

      // DirectionsService を利用
      const directionsService = new google.maps.DirectionsService();
      let request = {
        origin: origin,
        destination: destination,
        travelMode: google.maps.TravelMode.DRIVING
      };
      if (waypointAddress) {
        request.waypoints = [{ location: waypointAddress }];
      }

      directionsService.route(request, (result, status) => {
        if (status === google.maps.DirectionsStatus.OK) {
          const legs = result.routes[0].legs;
          let totalDurationSec = 0;
          let outputHtml = `<h2>${staffName} さんのルート</h2>`;
          outputHtml += `<p>出発時刻: ${departureTime.toLocaleTimeString()}</p>`;
          legs.forEach((leg, index) => {
            totalDurationSec += leg.duration.value; // 秒単位
            const arrivalTime = new Date(departureTime.getTime() + totalDurationSec * 1000);
            outputHtml += `<p>区間${index + 1}:<br> ${leg.start_address} → ${leg.end_address}<br>`;
            outputHtml += `移動時間: ${leg.duration.text}、到着予定時刻: ${arrivalTime.toLocaleTimeString()}</p>`;
          });
          document.getElementById("output").innerHTML = outputHtml;
        } else {
          document.getElementById("output").innerHTML = `<p>ルート検索に失敗しました: ${status}</p>`;
        }
      });
    });
  </script>
</body>
</html>
